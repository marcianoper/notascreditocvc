<!-- botón ya existe en tu HTML: #btnImprimir80RawBT -->
<script>
/* ===== ESC/POS por RawBT (Android) ===== */
function escposText(txt){ return txt.replace(/\n/g, "\n"); }
function toFixed2(n){ return Number(n||0).toFixed(2); }

async function imprimirNota80mmRawBT(nota_id){
  // guarda observaciones antes de imprimir
  await saveNotaObs();

  const { data: nota } = await supabase.from('notas_credito')
      .select('*, clientes(nombre)').eq('id', nota_id).single();
  const { data: det }  = await supabase.from('notas_detalle')
      .select('*').eq('nota_id', nota_id).order('created_at');

  const center   = "\x1B\x61\x01";   // ESC a 1  (centrar)
  const left     = "\x1B\x61\x00";   // ESC a 0  (izquierda)
  const bold_on  = "\x1B\x45\x01";   // ESC E 1
  const bold_off = "\x1B\x45\x00";   // ESC E 0
  const cut_full = "\x1D\x56\x41\x00"; // GS V A 0 (corte completo, si la impresora tiene cortador)
  const init     = "\x1B\x40";       // ESC @ (init)

  // Formato simple: 48 columnas aprox. (depende de fuente del firmware)
  const line   = "------------------------------------------------\n";
  const store  = `${STORE_NAME}\n`;
  const head   =
    `Cliente: ${nota.clientes?.nombre||''}\n` +
    `Folio:   ${nota.folio}\n` +
    `Fecha:   ${nota.fecha}  Vence: ${nota.vence||''}\n`;

  const items = (det||[]).map(d=>{
    const l1 = `${d.producto}\n`;
    const l2 = `${toFixed2(d.cantidad)}kg x $${toFixed2(d.precio)}   `
             + `= $${toFixed2(d.importe)}\n`;
    return l1 + l2;
  }).join("");

  const totals =
    `\nTotal: $${toFixed2(nota.total)}\n` +
    `Saldo: $${toFixed2(nota.saldo)}\n`;

  const obs = nota.observaciones ? `\nNotas:\n${nota.observaciones}\n` : "";

  const thanks = "¡Gracias por su preferencia!\n\n";

  // armar el payload ESC/POS
  let payload =
    init +
    center + bold_on + store + bold_off +
    left + head + line +
    items + line +
    totals +
    obs +
    center + thanks +
    cut_full;

  // Codificar a base64 y abrir con RawBT
  const b64 = btoa(unescape(encodeURIComponent(payload)));
  // dos rutas compatibles: rawbt: y el intent://
  const url1 = `rawbt:${b64}`;
  const url2 = `intent:${b64}#Intent;scheme=rawbt;package=ru.a402d.rawbtprinter;end`;

  // primero intent (suele funcionar mejor en algunos Android)
  let w = window.open(url2, '_blank');
  setTimeout(()=>{ if(!w || w.closed) window.open(url1, '_blank'); }, 600);
}

// wire up (añade el listener si no lo tienes):
const btnRawBT = document.getElementById('btnImprimir80RawBT');
if (btnRawBT) {
  btnRawBT.addEventListener('click', ()=> {
    const n = activeNota();
    if (!n) return alert('Primero carga una nota');
    imprimirNota80mmRawBT(n.id);
  });
}
</script>
