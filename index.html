<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VDC360¬∞ ‚Äî Notas a Cr√©dito (Slots A/B + Reporte Diario)</title>
  <style>
    :root{--ink:#111;--brand:#0a7a3b;--muted:#6b7280;--bg:#f6f7f8;--card:#fff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto}
    header{background:var(--brand);color:#fff;padding:14px 18px}
    header h1{margin:0;font-size:18px}
    main{max-width:1240px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:16px}
    h2{margin:0 0 10px 0;font-size:18px}
    label{display:block;margin-top:8px;font-size:14px;color:#111}
    input,select,button,textarea{width:100%;padding:10px;margin-top:6px;font-size:14px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #eef0f2;text-align:left;font-size:14px}
    th{background:#fafafa}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .grid-2{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .btn{cursor:pointer}
    .btn-primary{background:var(--brand);color:#fff;border:none}
    .btn-ghost{background:#fff;border:1px solid #e5e7eb;color:#111}
    .btn-muted{background:#111;color:#fff;border:none}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef7f0;color:#0a7a3b;font-size:12px}
    .muted{color:var(--muted);font-size:13px}
    .danger{color:#b91c1c}
    .slotbar{display:flex;gap:8px;align-items:center;margin-top:8px}
    .slotbtn{border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
    .slotbtn.active{background:#0a7a3b;color:#fff;border-color:#0a7a3b}
    .btn-sm{padding:4px 8px;font-size:12px}
    .cell-editing input{width:100%; padding:6px; font-size:14px}
    @media print{
      body *{visibility:hidden}
      #printArea, #printArea *{visibility:visible}
      #printArea{position:fixed; left:0; top:0; width:210mm; padding:12mm}
      #printArea h3{margin:0 0 6mm 0}
      #printArea table{width:100%; border-collapse:collapse}
      #printArea th, #printArea td{border:1px solid #aaa; padding:4px; font-size:12px}
      .group{margin-top:6mm}
    }
  </style>
</head>
<body>
<header>
  <h1>VDC360¬∞ ¬∑ Notas a Cr√©dito (Slots A/B + Reporte Diario) 1</h1>
</header>

<main>
  <!-- SLOTS A/B -->
  <section class="card">
    <h2>üß≠ Trabajo en paralelo (2 clientes)</h2>
    <div class="slotbar">
      <button class="slotbtn active" id="slotA">Slot A</button>
      <span class="pill" id="slotALabel">‚Äî</span>
      <button class="slotbtn" id="slotB">Slot B</button>
      <span class="pill" id="slotBLabel">‚Äî</span>

      <span class="right flex" style="gap:6px">
        <input type="checkbox" id="exitGuardToggle" />
        <label for="exitGuardToggle" class="muted">Confirmar al salir</label>
      </span>
    </div>
  </section>

  <!-- CONTROLES (slot activo) -->
  <section class="card">
    <h2>üßæ Nota (Slot activo)</h2>
    <div class="row">
      <div>
        <label>Cliente</label>
        <div class="flex" style="gap:6px; align-items:stretch">
          <select id="cliSelect"></select>
          <button class="btn btn-ghost" id="btnNuevoCliente">+ Cliente</button>
        </div>
      </div>
      <div>
        <label>Tel√©fono (WhatsApp)</label>
        <input id="cliTelefono" placeholder="10 d√≠gitos" />
      </div>
    </div>
    <div class="row-3">
      <div>
        <label>Folio</label>
        <input id="notaFolio" placeholder="Autogenerado" />
      </div>
      <div>
        <label>Fecha</label>
        <input id="notaFecha" type="date" />
      </div>
      <div>
        <label>D√≠as de cr√©dito</label>
        <select id="notaDias">
          <option value="7">7</option>
          <option value="15">15</option>
          <option value="30" selected>30</option>
          <option value="45">45</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Vence</label>
        <input id="notaVence" type="date" />
      </div>
      <div>
        <label>&nbsp;</label>
        <div class="flex">
          <button class="btn btn-primary" id="btnContinuar">Crear / Continuar Nota en Slot Activo</button>
          <span class="pill right" id="notaInfo">Sin nota en slot</span>
        </div>
      </div>
    </div>
  </section>

  <div class="grid-2">
    <!-- CAPTURA -->
    <section class="card">
      <h2>üß∫ Capturar partidas</h2>
      <div class="row-3">
        <div>
          <label>Producto</label>
          <input id="pProducto" list="catProductos" placeholder="Ej. Panza de Res" />
        </div>
        <div>
          <label>Kilos</label>
          <div class="flex" style="gap:6px; align-items:center">
            <input id="pKg" type="number" min="0" step="0.01" value="1" />
            <div class="flex">
              <button class="btn btn-ghost btnInc" data-d="0.1" type="button">+0.1</button>
              <button class="btn btn-ghost btnInc" data-d="0.5" type="button">+0.5</button>
              <button class="btn btn-ghost btnInc" data-d="1"   type="button">+1</button>
            </div>
          </div>
        </div>
        <div>
          <label>Precio/kg</label>
          <input id="pPrecio" type="number" min="0" step="0.01" value="0" />
        </div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn btn-primary" id="btnAgregar">Agregar a nota (Enter)</button>
        <span class="pill right" id="subtotalBox">Subtotal: $0.00</span>
      </div>
      <label>Observaciones</label>
      <textarea id="notaObs" rows="2" placeholder="Instrucciones, cortes, etc."></textarea>
    </section>

    <!-- VISTA EN VIVO -->
    <section class="card">
      <h2>üë§ Vista del cliente (slot activo)</h2>
      <div class="flex" style="gap:6px;margin-bottom:6px">
        <div class="pill">Folio: <span id="vFolio">‚Äî</span></div>
        <div class="pill">Estado: <span id="vEstado">‚Äî</span></div>
        <div class="pill">Saldo: $<span id="vSaldo">0.00</span></div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th>Producto</th>
            <th>Kg</th>
            <th>P.Unit</th>
            <th>Importe</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="vistaBody"></tbody>
        <tfoot><tr><td colspan="5" style="text-align:right">Total</td><td id="vistaTotal">$0.00</td></tr></tfoot>
      </table>
    </section>
  </div>

  <!-- BANDEJA -->
  <section class="card">
    <h2>üì• Notas abiertas hoy (todas)</h2>
    <div class="row">
      <div>
        <label>Fecha</label>
        <input id="bandejaFecha" type="date" />
      </div>
      <div>
        <label>&nbsp;</label>
        <div class="flex">
          <button class="btn btn-ghost" id="btnBandeja">Actualizar</button>
          <span class="muted">Carga una nota al Slot A o B para alternar r√°pido.</span>
        </div>
      </div>
    </div>
    <table>
      <thead><tr><th>Folio</th><th>Cliente</th><th>Saldo</th><th>Estado</th><th>Acciones</th></tr></thead>
      <tbody id="bandejaBody"></tbody>
    </table>
  </section>

  <!-- REPORTE DIARIO GENERAL -->
  <section class="card">
    <h2>üìÑ Reporte diario GENERAL (todos los clientes)</h2>
    <div class="row">
      <div>
        <label>Fecha</label>
        <input id="diaFecha" type="date" />
      </div>
      <div>
        <label>&nbsp;</label>
        <div class="flex">
          <button class="btn btn-ghost" id="btnDiaA4">Imprimir A4 (todos)</button>
          <button class="btn btn-ghost" id="btnDiaCSV">CSV (todos)</button>
          <span class="pill right" id="diaResumen">‚Äî</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ACCIONES NOTA -->
  <section class="card">
    <div class="flex">
      <button class="btn btn-ghost" id="btnWA">WhatsApp Cuenta</button>
      <button class="btn btn-ghost" id="btnImprimir">Imprimir A4</button>
      <button class="btn btn-ghost" id="btnTicket">Ticket (RawBT)</button>
      <button class="btn btn-ghost" id="btnCSV">Exportar CSV</button>
      <button class="btn btn-ghost danger right" id="btnCerrar">Cerrar Nota</button>
    </div>
  </section>
</main>

<!-- PRINT AREA + CAT√ÅLOGO -->
<div id="printArea" style="display:none"></div>
<datalist id="catProductos"></datalist>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ========================= CONFIG ========================= */
const SUPABASE_URL = "https://bjebybdqcqscouxlinfd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqZWJ5YmRxY3FzY291eGxpbmZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMjQ3MTksImV4cCI6MjA3MTkwMDcxOX0.mQgWtiYEyJTiF04pdcLv63SqPNrU1Iehws0vKqr82O0";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const STORE_NAME = "Carnes y V√≠sceras del Centro";

/* ========================= UTILS ========================= */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const to2 = n=> Number(n||0).toFixed(2);
function todayISO(){ const d=new Date(); const z=d.getTimezoneOffset()*60000; return new Date(d-z).toISOString().slice(0,10); }
function addDays(dateISO, days){ const d=new Date(dateISO); d.setDate(d.getDate()+Number(days||0)); const z=d.getTimezoneOffset()*60000; return new Date(d - z).toISOString().slice(0,10); }
function genFolio(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return `CVC-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`; }
function csvEscape(s){ return '"'+String(s).replaceAll('"','""')+'"'; }
function openWA(text, phone){
  const msg=encodeURIComponent(text);
  if(phone && /\d{10,13}/.test(phone)){
    const num=String(phone).replace(/\D/g,'');
    window.open(`https://wa.me/${num}?text=${msg}`,"_blank");
  } else {
    const u=`https://wa.me/?text=${msg}`; const u2=`https://api.whatsapp.com/send?text=${msg}`;
    const w=window.open(u,"_blank"); setTimeout(()=>{ if(!w||w.closed) window.open(u2,"_blank"); }, 600);
  }
}

/* ========= HELPERS TICKET (80mm, 48 columnas) ========= */
const COLS = 48;         // 80mm (font A). Si tu impresora real usa 42/64, cambia aqu√≠.
const EOL  = "\r\n";     // CRLF para RawBT
const isAndroid = /Android/i.test(navigator.userAgent);

const cut = (s,n)=> String(s??'').slice(0,n);
const padR=(s,n)=>{s=String(s??'');return s.length>=n?s.slice(0,n):s+' '.repeat(n-s.length);}
const padL=(s,n)=>{s=String(s??'');return s.length>=n?s.slice(-n):' '.repeat(n-s.length)+s;}
const line=()=> '-'.repeat(COLS);
const center=t=>{t=String(t??''); const sp=Math.max(0, Math.floor((COLS - t.length)/2)); return ' '.repeat(sp)+t;}
const twoColsL=(l,r,w=COLS)=>{r=String(r); const left=cut(l, Math.max(0, w - r.length - 1)); return padR(left, w - r.length - 1)+' '+r;};

// Intent launcher (texto)
function rawbtSendText(text){
  const payload = encodeURIComponent(text);
  const intent  = `intent:${payload}#Intent;scheme=rawbt;package=ru.a402d.rawbtprinter;end;`;
  const a = document.createElement('a');
  a.setAttribute('href', intent);
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>document.body.removeChild(a), 50);
}

// Intent launcher (imagen base64) ‚Äî fallback para tickets largos
function rawbtSendImageBase64(dataUrl){
  const base = dataUrl.replace(/^data:/,''); // "image/png;base64,AAAA..."
  const intent = `intent:${base}#Intent;scheme=rawbt:data;package=ru.a402d.rawbtprinter;end;`;
  const a = document.createElement('a');
  a.setAttribute('href', intent);
  a.style.display='none';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>document.body.removeChild(a), 50);
}

// Render de texto a PNG (monoespaciado)
function ticketToPng(text, widthPx=576, fontSize=22){
  return new Promise(resolve=>{
    const lines = text.split(/\r?\n/);
    const lineH = Math.round(fontSize * 1.25);
    const heightPx = Math.max(200, lineH * (lines.length + 3));

    const c = document.createElement('canvas');
    c.width = widthPx;
    c.height = heightPx;
    const ctx = c.getContext('2d');

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,c.width,c.height);

    ctx.fillStyle = '#000000';
    ctx.font = `bold ${fontSize}px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace`;
    ctx.textBaseline = 'top';

    const padX = 8;
    let y = 8;
    for(const ln of lines){
      ctx.fillText(ln, padX, y);
      y += lineH;
    }
    resolve(c.toDataURL('image/png'));
  });
}

/* ========================= STATE (SLOTS + GUARD) ========================= */
let CLIENTES=[], PRODUCTOS=[], PRECIOS={};
let slotActive='A';
let notaA=null, notaB=null;
let chA=null, chB=null;
const slotState = { A:{cliente_id:null, telefono:null}, B:{cliente_id:null, telefono:null} };

// NUEVO: protector de salida
let exitGuardEnabled = JSON.parse(localStorage.getItem('exitGuardEnabled') || 'true');
let isDirty = false;
function markDirty(){ if(exitGuardEnabled) isDirty = true; }
function clearDirty(){ isDirty = false; }

/* ========================= REFS ========================= */
const exitGuardToggle=$('#exitGuardToggle');
const slotABtn=$('#slotA'), slotBBtn=$('#slotB');
const slotALabel=$('#slotALabel'), slotBLabel=$('#slotBLabel');

const cliSelect=$('#cliSelect');
const cliTelefono=$('#cliTelefono');
const notaFolio=$('#notaFolio');
const notaFecha=$('#notaFecha');
const notaDias=$('#notaDias');
const notaVence=$('#notaVence');
const notaInfo=$('#notaInfo');

const pProducto=$('#pProducto');
const pKg=$('#pKg');
const pPrecio=$('#pPrecio');
const subtotalBox=$('#subtotalBox');

const vFolio=$('#vFolio');
const vEstado=$('#vEstado');
const vSaldo=$('#vSaldo');
const vistaBody=$('#vistaBody');
const vistaTotal=$('#vistaTotal');

const bandejaFecha=$('#bandejaFecha');
const bandejaBody=$('#bandejaBody');
const diaFecha=$('#diaFecha');
const diaResumen=$('#diaResumen');

/* ========================= INIT ========================= */
notaFecha.value=todayISO();
notaVence.value=addDays(notaFecha.value, notaDias.value);
bandejaFecha.value=todayISO();
diaFecha.value=todayISO();

exitGuardToggle.checked = exitGuardEnabled;
exitGuardToggle.addEventListener('change', ()=>{
  exitGuardEnabled = exitGuardToggle.checked;
  localStorage.setItem('exitGuardEnabled', JSON.stringify(exitGuardEnabled));
  if(!exitGuardEnabled) clearDirty();
});
window.addEventListener('beforeunload', (e)=>{
  if(exitGuardEnabled && isDirty){
    e.preventDefault();
    e.returnValue = '';
  }
});

notaDias.addEventListener('change', ()=> { notaVence.value=addDays(notaFecha.value, notaDias.value); });
notaFecha.addEventListener('change', ()=> { notaVence.value=addDays(notaFecha.value, notaDias.value); });

['keyup','change'].forEach(ev=> pProducto.addEventListener(ev, ()=>{ prefPrecio(); markDirty(); }));
['keyup','change'].forEach(ev=> pKg.addEventListener(ev, markDirty));
['keyup','change'].forEach(ev=> pPrecio.addEventListener(ev, markDirty));
['keyup','change'].forEach(ev=> $('#notaObs').addEventListener(ev, markDirty));

$$('.btnInc').forEach(b=> b.addEventListener('click', ()=>{ pKg.value=(Number(pKg.value||0)+Number(b.dataset.d||0)).toFixed(2); markDirty(); }));

document.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && document.activeElement && ['pProducto','pKg','pPrecio'].includes(document.activeElement.id)){ e.preventDefault(); addPartida(); }});

// Botones
$('#btnContinuar').addEventListener('click', continuarNota);
$('#btnAgregar').addEventListener('click', addPartida);
$('#btnWA').addEventListener('click', ()=> activeNota() && waNota(activeNota().id));
$('#btnImprimir').addEventListener('click', ()=> activeNota() && imprimirNotaA4(activeNota().id));
$('#btnTicket').addEventListener('click', ()=> activeNota() && imprimirNotaRawBT(activeNota().id));
$('#btnCSV').addEventListener('click', ()=> activeNota() && exportNotaCSV(activeNota().id));
$('#btnCerrar').addEventListener('click', cerrarNota);
$('#btnNuevoCliente').addEventListener('click', addCliente);
$('#btnBandeja').addEventListener('click', loadBandeja);
$('#btnDiaA4').addEventListener('click', imprimirDiaA4);
$('#btnDiaCSV').addEventListener('click', exportDiaCSV);

// Cambios de cliente/tel√©fono ligados al slot activo
cliSelect.addEventListener('change', ()=>{
  slotState[slotActive].cliente_id = cliSelect.value || null;
  const c = getClient(slotState[slotActive].cliente_id);
  cliTelefono.value = c ? (c.telefono || '') : '';
  slotState[slotActive].telefono = cliTelefono.value || null;
});
cliTelefono.addEventListener('blur', async ()=>{ await saveClientPhone(); });

slotABtn.onclick=()=> setActiveSlot('A');
slotBBtn.onclick=()=> setActiveSlot('B');

window.addEventListener('load', async ()=>{
  await Promise.all([loadClientes(), loadProductos()]);
  notaFolio.value=genFolio();
  await loadBandeja();
  if (CLIENTES[0]) {
    slotState.A.cliente_id = CLIENTES[0].id;
    slotState.A.telefono   = CLIENTES[0].telefono || null;
    applySlotUI('A');
  }
});

/* ========================= HELPERS ========================= */
function getClient(id){ return (CLIENTES||[]).find(c=> String(c.id)===String(id)); }
function getClientName(id){ return getClient(id)?.nombre || ''; }
function activeNota(){ return slotActive==='A' ? notaA : notaB; }
function setActiveSlot(s){
  slotActive=s;
  slotABtn.classList.toggle('active', s==='A');
  slotBBtn.classList.toggle('active', s==='B');
  applySlotUI(s);
  renderVista();
  refreshNotaInfo();
}
function setSlotNota(s, nota){
  if(s==='A'){ notaA=nota; subRealtime('A'); }
  else      { notaB=nota; subRealtime('B'); }
  slotState[s].cliente_id = nota.cliente_id || slotState[s].cliente_id;
  const c = getClient(slotState[s].cliente_id);
  slotState[s].telefono = c ? (c.telefono || null) : slotState[s].telefono;
  if(slotActive===s){ applySlotUI(s); renderVista(); }
  refreshNotaInfo();
}
function refreshNotaInfo(){
  slotALabel.textContent = notaA ? `${notaA.folio}` : '‚Äî';
  slotBLabel.textContent = notaB ? `${notaB.folio}` : '‚Äî';
  const n = activeNota();
  notaInfo.textContent = n ? `Nota: ${n.folio}` : 'Sin nota en slot';
}
function applySlotUI(s){
  const n   = (s==='A') ? notaA : notaB;
  const cid = (n?.cliente_id) || slotState[s].cliente_id || (CLIENTES[0]?.id || '');
  cliSelect.value = cid;
  const c = getClient(cid);
  cliTelefono.value = (n && c) ? (c.telefono || '') : (slotState[s].telefono || c?.telefono || '');
}

/* ========================= CAT√ÅLOGOS ========================= */
async function loadClientes(){
  const { data, error } = await supabase.from('clientes').select('id, nombre, telefono').order('nombre');
  if(error){ console.error(error); alert('No se pudieron cargar CLIENTES'); return; }
  CLIENTES = data || [];
  cliSelect.innerHTML = (CLIENTES||[]).map(c=>`<option value="${c.id}">${c.nombre}</option>`).join('');
}
async function loadProductos(){
  let { data, error } = await supabase.from('productos').select('id,nombre,precio_kg,activo').eq('activo', true).order('nombre');
  if(error){ ({ data } = await supabase.from('productos').select('id,nombre,precio_kg').order('nombre')); }
  PRODUCTOS = data || [];
  PRECIOS = Object.fromEntries(PRODUCTOS.map(p=>[p.nombre, Number(p.precio_kg||0).toFixed(2)]));
  $('#catProductos').innerHTML = PRODUCTOS.map(p=>`<option value="${p.nombre}"></option>`).join('');
}
function prefPrecio(){ const n=(pProducto.value||'').trim(); if(PRECIOS[n]) pPrecio.value=PRECIOS[n]; }

/* ========================= GUARDAR TEL√âFONO ========================= */
async function saveClientPhone(){
  const cid = slotState[slotActive].cliente_id || activeNota()?.cliente_id;
  if(!cid) return;
  const val = (cliTelefono.value||'').trim() || null;
  try{
    await supabase.from('clientes').update({ telefono: val }).eq('id', cid);
    const c = getClient(cid); if(c) c.telefono = val;
    slotState[slotActive].telefono = val;
  }catch(e){ console.error(e); }
}

/* ========================= CREAR/CONTINUAR NOTA ========================= */
async function continuarNota(){
  const cliente_id = slotState[slotActive].cliente_id || cliSelect.value;
  if(!cliente_id) return alert('Selecciona cliente');
  const fecha = notaFecha.value || todayISO();

  let { data: nota } = await supabase
    .from('notas_credito').select('*')
    .eq('cliente_id', cliente_id).eq('fecha', fecha).eq('estado','abierta')
    .order('created_at', {ascending:false}).limit(1).maybeSingle();

  if(!nota){
    const folio = genFolio();
    const payload = { id: crypto.randomUUID(), folio, fecha, vence:(notaVence.value||addDays(fecha, notaDias.value)), cliente_id, total:0, saldo:0, observaciones: ($('#notaObs').value||null) };
    const { error } = await supabase.from('notas_credito').insert(payload);
    if(error){ console.error(error); return alert('No se pudo crear la nota'); }
    nota = payload;
  }
  setSlotNota(slotActive, nota);
  notaFolio.value = nota.folio;
}

/* ========================= NUEVO CLIENTE ========================= */
async function addCliente(){
  const nombre = prompt('Nombre del cliente:'); if(!nombre || !nombre.trim()) return;
  const telefono = prompt('Tel√©fono (WhatsApp, opcional):') || null;
  const row = { id: crypto.randomUUID(), nombre: nombre.trim(), telefono: telefono||null };
  const { error } = await supabase.from('clientes').insert(row);
  if(error){ console.error(error); return alert('No se pudo crear el cliente (RLS/SQL)'); }
  await loadClientes();
  const c = CLIENTES.find(x=>x.nombre===nombre.trim());
  if(c){ slotState[slotActive].cliente_id=c.id; slotState[slotActive].telefono=c.telefono||null; applySlotUI(slotActive); }
  alert('‚úÖ Cliente creado');
}

/* ========================= INSERTAR PARTIDA ========================= */
async function addPartida(){
  const nota = activeNota(); if(!nota) return alert('Primero crea/contin√∫a una nota en el slot activo');
  const prod=(pProducto.value||'').trim(), cant=Number(pKg.value||0), precio=Number(pPrecio.value||0);
  if(!prod || cant<=0) return alert('Producto y kilos son obligatorios');
  const { error } = await supabase.from('notas_detalle').insert({ id: crypto.randomUUID(), nota_id: nota.id, producto: prod, cantidad: cant, precio, importe: cant*precio });
  if(error){ console.error(error); return alert('No se pudo agregar la partida'); }
  pProducto.value=''; pKg.value='1'; prefPrecio();
  clearDirty();
  await recalcNota(nota.id);
}
async function recalcNota(nota_id){
  let total=0;
  try{ const { data }=await supabase.rpc('sum_importe_nota',{p_nota_id:nota_id}); total=Number(data?.total||0); }
  catch{ const { data }=await supabase.from('notas_detalle').select('importe').eq('nota_id', nota_id); total=(data||[]).reduce((a,b)=>a+Number(b.importe||0),0); }
  await supabase.from('notas_credito').update({ total, saldo: total }).eq('id', nota_id);
  await renderVista();
  await loadBandeja();
}

/* ========================= VISTA (SLOT ACTIVO) ‚Äî EDITAR/BORRAR ========================= */
async function renderVista(){
  const n = activeNota();
  if(!n){
    vFolio.textContent='‚Äî'; vEstado.textContent='‚Äî'; vSaldo.textContent='0.00';
    vistaBody.innerHTML=''; vistaTotal.textContent='$0.00'; subtotalBox.textContent='Subtotal: $0.00';
    refreshNotaInfo(); return;
  }

  const { data: nota } = await supabase.from('notas_credito').select('*').eq('id', n.id).single();
  const { data: det }  = await supabase.from('notas_detalle').select('*').eq('nota_id', n.id).order('created_at');

  if(slotActive==='A') notaA=nota; else notaB=nota;
  slotState[slotActive].cliente_id = nota.cliente_id;
  const c = getClient(nota.cliente_id);
  slotState[slotActive].telefono = c ? (c.telefono || null) : slotState[slotActive].telefono;

  applySlotUI(slotActive);
  vFolio.textContent = nota.folio; vEstado.textContent = nota.estado||'abierta'; vSaldo.textContent = to2(nota.saldo||0);

  vistaBody.innerHTML = (det||[]).map(d=>`
    <tr data-id="${d.id}">
      <td>${new Date(d.created_at).toLocaleString()}</td>
      <td>${d.producto}</td>
      <td class="editable" data-field="cantidad">${to2(d.cantidad)}</td>
      <td class="editable" data-field="precio">$${to2(d.precio)}</td>
      <td>$${to2(d.importe)}</td>
      <td><button class="btn btn-ghost btn-sm" data-del="${d.id}" title="Borrar">üóëÔ∏è</button></td>
    </tr>
  `).join('');

  const tot=(det||[]).reduce((a,b)=>a+Number(b.importe||0),0);
  vistaTotal.textContent=`$${to2(tot)}`; 
  subtotalBox.textContent=`Subtotal: $${to2(tot)}`;

  vistaBody.querySelectorAll('[data-del]').forEach(b=>{ b.onclick = ()=> deleteDetalle(b.dataset.del); });
  vistaBody.querySelectorAll('.editable').forEach(td=>{ td.addEventListener('click', ()=> makeCellEditable(td, n.id)); });

  refreshNotaInfo();
}

/* ===== Editar en l√≠nea Kg o Precio ===== */
function makeCellEditable(td, nota_id){
  if(td.classList.contains('cell-editing')) return;
  const field = td.dataset.field;
  const row   = td.closest('tr');
  const detId = row.dataset.id;
  const raw   = td.textContent.replace('$','').trim();
  const oldV  = Number(raw.replace(',', '.')) || 0;

  td.classList.add('cell-editing');
  const input = document.createElement('input');
  input.type = 'number'; input.step = '0.01'; input.min  = '0';
  input.value = oldV.toFixed(2);
  td.innerHTML = ''; td.appendChild(input);
  input.focus(); input.select();
  markDirty();

  const commit = async(save)=>{
    const newV = Number(input.value||0);
    td.classList.remove('cell-editing');
    td.innerHTML = field==='precio' ? `$${to2(save?newV:oldV)}` : to2(save?newV:oldV);
    if(!save){ clearDirty(); return; }

    const { data: cur } = await supabase.from('notas_detalle').select('cantidad, precio').eq('id', detId).single();
    const cantidad = field==='cantidad' ? newV : Number(cur?.cantidad||0);
    const precio   = field==='precio'   ? newV : Number(cur?.precio||0);
    const importe  = cantidad * precio;

    await supabase.from('notas_detalle').update({ cantidad, precio, importe }).eq('id', detId);
    clearDirty();
    await recalcNota(nota_id);
  };

  input.addEventListener('keydown', e=>{ if(e.key==='Enter') commit(true); if(e.key==='Escape') commit(false); });
  input.addEventListener('blur', ()=> commit(true));
}

/* ===== Borrar partida ===== */
async function deleteDetalle(detId){
  if(!confirm('¬øBorrar esta partida?')) return;
  const n = activeNota(); if(!n) return;
  await supabase.from('notas_detalle').delete().eq('id', detId);
  await recalcNota(n.id);
}

/* ========================= REALTIME ========================= */
function subRealtime(slot){
  const nota = slot==='A'? notaA : notaB;
  if(!nota) return;
  if(slot==='A' && chA){ supabase.removeChannel(chA); chA=null; }
  if(slot==='B' && chB){ supabase.removeChannel(chB); chB=null; }
  const ch = supabase.channel(`rt-${slot}-${nota.id}`)
    .on('postgres_changes', {event:'*',schema:'public',table:'notas_detalle',filter:`nota_id=eq.${nota.id}`}, ()=>{ if(slot===slotActive) renderVista(); })
    .on('postgres_changes', {event:'update',schema:'public',table:'notas_credito',filter:`id=eq.${nota.id}`}, ()=>{ if(slot===slotActive) renderVista(); })
    .subscribe();
  if(slot==='A') chA=ch; else chB=ch;
}

/* ========================= BANDEJA ========================= */
async function loadBandeja(){
  const f = bandejaFecha.value || todayISO();
  const { data } = await supabase
    .from('notas_credito')
    .select('id,folio,saldo,estado,clientes(nombre),cliente_id')
    .eq('fecha', f).eq('estado','abierta').order('created_at');
  const rows=data||[];
  bandejaBody.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.folio}</td>
      <td>${r.clientes?.nombre||''}</td>
      <td>$${to2(r.saldo||0)}</td>
      <td>${r.estado||'abierta'}</td>
      <td class="flex">
        <button class="btn btn-ghost" data-usea="${r.id}" data-cid="${r.cliente_id}">Usar en A</button>
        <button class="btn btn-ghost" data-useb="${r.id}" data-cid="${r.cliente_id}">Usar en B</button>
        <button class="btn btn-ghost" data-a4="${r.id}">A4</button>
        <button class="btn btn-ghost" data-ticket="${r.id}">Ticket</button>
        <button class="btn btn-ghost" data-wa="${r.id}">WA</button>
      </td>
    </tr>`).join('');
  bandejaBody.querySelectorAll('[data-usea]').forEach(b=> b.onclick = ()=> cargarEnSlot('A', b.dataset.usea, b.dataset.cid));
  bandejaBody.querySelectorAll('[data-useb]').forEach(b=> b.onclick = ()=> cargarEnSlot('B', b.dataset.useb, b.dataset.cid));
  bandejaBody.querySelectorAll('[data-a4]').forEach(b=> b.onclick = ()=> imprimirNotaA4(b.dataset.a4));
  bandejaBody.querySelectorAll('[data-ticket]').forEach(b=> b.onclick = ()=> imprimirNotaRawBT(b.dataset.ticket));
  bandejaBody.querySelectorAll('[data-wa]').forEach(b=> b.onclick = ()=> waNota(b.dataset.wa));
}
async function cargarEnSlot(slot, nota_id, cliente_id){
  const { data: nota } = await supabase.from('notas_credito').select('*').eq('id', nota_id).single();
  if(!nota) return;
  setSlotNota(slot, nota);
  slotState[slot].cliente_id = cliente_id || nota.cliente_id;
  const c = getClient(slotState[slot].cliente_id);
  slotState[slot].telefono = c ? (c.telefono || null) : null;
  setActiveSlot(slot);
}

/* ========================= WHATSAPP / A4 / CSV ========================= */
function plantillaWA(nota, det, clienteNombre){
  const items = (det||[]).map(d=>`‚Ä¢ ${d.producto} ${to2(d.cantidad)}kg √ó $${to2(d.precio)} = $${to2(d.importe)}`).join('\n');
  return [
    `Hola *${clienteNombre}*,`,
    `te compartimos el detalle de tu cuenta del d√≠a:\n`,
    `*Folio:* ${nota.folio}`,
    `*Fecha:* ${nota.fecha}  |  *Vence:* ${nota.vence || 's/d'}`,
    '',
    items,
    '',
    `*Total:* $${to2(nota.total)}   |   *Saldo:* $${to2(nota.saldo)}`,
    '',
    `¬°Gracias por tu preferencia! ‚Äî ${STORE_NAME}`
  ].join('\n');
}
async function waNota(nota_id){
  const { data: nota } = await supabase.from('notas_credito').select('*').eq('id', nota_id).single();
  const { data: det }  = await supabase.from('notas_detalle').select('*').eq('nota_id', nota_id).order('created_at');
  const nombre = getClientName(nota.cliente_id);
  let phone = slotState[slotActive].telefono;
  if(!phone || (activeNota()?.cliente_id!==nota.cliente_id)){
    const c = getClient(nota.cliente_id); phone = c ? (c.telefono||'') : '';
  }
  openWA(plantillaWA(nota, det||[], nombre), phone);
}
async function imprimirNotaA4(nota_id){
  const { data: nota } = await supabase.from('notas_credito').select('*, clientes(nombre)').eq('id', nota_id).single();
  const { data: det }  = await supabase.from('notas_detalle').select('*').eq('nota_id', nota_id).order('created_at');
  const el = $('#printArea'); el.style.display='block';
  el.innerHTML = `
    <h3>Nota ‚Äî ${nota.clientes?.nombre||''}</h3>
    <div><b>Folio:</b> ${nota.folio} &nbsp; <b>Fecha:</b> ${nota.fecha} &nbsp; <b>Vence:</b> ${nota.vence||''}</div>
    <div><b>Total:</b> $${to2(nota.total)} &nbsp; <b>Saldo:</b> $${to2(nota.saldo)}</div>
    <br/>
    <table>
      <thead><tr><th>Fecha/Hora</th><th>Producto</th><th>Kg</th><th>P.Unit</th><th>Importe</th></tr></thead>
      <tbody>${(det||[]).map(d=>`<tr><td>${new Date(d.created_at).toLocaleString()}</td><td>${d.producto}</td><td>${to2(d.cantidad)}</td><td>$${to2(d.precio)}</td><td>$${to2(d.importe)}</td></tr>`).join('')}</tbody>
    </table>`;
  window.print(); setTimeout(()=>{ el.style.display='none'; el.innerHTML=''; }, 500);
}
async function exportNotaCSV(nota_id){
  const { data: nota } = await supabase.from('notas_credito').select('*').eq('id', nota_id).single();
  const { data: det }  = await supabase.from('notas_detalle').select('*').eq('nota_id', nota_id).order('created_at');
  const head=['Folio','Fecha','Hora','Producto','Kg','Precio','Importe'];
  const rows=(det||[]).map(d=>[nota.folio, nota.fecha, new Date(d.created_at).toLocaleTimeString(), d.producto, to2(d.cantidad), to2(d.precio), to2(d.importe)]);
  const csv=[head,...rows].map(r=>r.map(csvEscape).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`nota_${nota.folio}.csv`; a.click(); URL.revokeObjectURL(url);
}

/* ========================= TICKET RAWBT (80mm) ========================= */
async function imprimirNotaRawBT(nota_id){
  if(!isAndroid){
    alert('Para ticket directo usa Android con RawBT. Te abro A4 como respaldo.');
    return imprimirNotaA4(nota_id);
  }
  const { data: nota } = await supabase.from('notas_credito').select('*, clientes(nombre)').eq('id', nota_id).single();
  const { data: det }  = await supabase.from('notas_detalle').select('*').eq('nota_id', nota_id).order('created_at');

  const cliente = nota.clientes?.nombre || '';
  const fecha   = nota.fecha || todayISO();
  const vence   = nota.vence || '';
  const folio   = nota.folio || '';
  const obs     = (nota.observaciones || '').trim();

  // Texto 80mm
  let out = "";
  out += center(STORE_NAME) + EOL;
  out += center("NOTA A CR√âDITO") + EOL;
  out += line() + EOL;
  out += twoColsL(`Folio: ${folio}`, fecha) + EOL;
  out += twoColsL(`Cliente: ${cut(cliente, 28)}`, `Vence: ${vence}`) + EOL;
  out += line() + EOL;
  out += "Producto                   Kg   P.Unit   Importe" + EOL;
  out += line() + EOL;

  (det||[]).forEach(d=>{
    const prod = cut(d.producto, 25);
    const kg   = padL(to2(d.cantidad), 5);
    const pu   = padL(to2(d.precio),   8);
    const imp  = padL(to2(d.importe),  8);
    out += `${padR(prod,25)}  ${kg} ${pu} ${imp}${EOL}`;
  });

  out += line() + EOL;
  out += twoColsL("TOTAL:", `$${to2(nota.total)}`) + EOL;
  out += twoColsL("SALDO:", `$${to2(nota.saldo)}`) + EOL;
  if(obs){
    out += line() + EOL;
    const wrap = s => s.match(new RegExp(`.{1,${COLS}}`, 'g')) || [];
    wrap("Obs: " + obs).forEach(l => out += l + EOL);
  }
  out += line() + EOL;
  out += center("¬°Gracias por su preferencia!") + EOL + EOL + EOL;

  try{
    if(out.length <= 1800){
      rawbtSendText(out);                // Enviar como texto (r√°pido)
    }else{
      const dataUrl = await ticketToPng(out, 576, 22); // Fallback: imagen
      rawbtSendImageBase64(dataUrl);
    }
  }catch(e){
    console.error(e);
    alert('No fue posible abrir RawBT. Verifica que est√© instalado, configurado y con la impresora enlazada.');
  }
}

/* ========================= REPORTE DIARIO GENERAL ========================= */
async function imprimirDiaA4(){
  const f = diaFecha.value || todayISO();
  const { data: notas } = await supabase
    .from('notas_credito')
    .select('id, folio, fecha, clientes(nombre), cliente_id')
    .eq('fecha', f)
    .order('clientes(nombre), created_at');

  const ids=(notas||[]).map(n=>n.id);
  if(!ids.length) return alert('No hay notas ese d√≠a');

  const { data: det } = await supabase
    .from('notas_detalle')
    .select('nota_id, producto, cantidad, precio, importe, created_at')
    .in('nota_id', ids)
    .order('created_at');

  const byClient={};
  (notas||[]).forEach(n=>{
    const cliente = n.clientes?.nombre || '‚Äî';
    byClient[cliente] = byClient[cliente] || { notas: [], items: [] };
    byClient[cliente].notas.push(n);
  });
  (det||[]).forEach(d=>{
    const nn=(notas||[]).find(x=>x.id===d.nota_id);
    const cliente=nn?.clientes?.nombre || '‚Äî';
    byClient[cliente].items.push({ folio:nn?.folio, ...d });
  });

  const el=$('#printArea'); el.style.display='block';
  let html=`<h3>Reporte diario ‚Äî ${f}</h3>`;
  Object.entries(byClient).forEach(([cliente, pack])=>{
    const totalCliente=(pack.items||[]).reduce((a,b)=>a+Number(b.importe||0),0);
    html += `<div class="group"><h4>${cliente} ‚Äî Total: $${to2(totalCliente)}</h4>
      <table>
        <thead><tr><th>Folio</th><th>Hora</th><th>Producto</th><th>Kg</th><th>P.Unit</th><th>Importe</th></tr></thead>
        <tbody>
          ${(pack.items||[]).map(d=>`<tr>
            <td>${d.folio||''}</td>
            <td>${new Date(d.created_at).toLocaleTimeString()}</td>
            <td>${d.producto}</td>
            <td>${to2(d.cantidad)}</td>
            <td>$${to2(d.precio)}</td>
            <td>$${to2(d.importe)}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`;
  });
  el.innerHTML=html;
  window.print(); setTimeout(()=>{ el.style.display='none'; el.innerHTML=''; }, 500);

  const totalDia=(det||[]).reduce((a,b)=>a+Number(b.importe||0),0);
  diaResumen.textContent=`Clientes: ${Object.keys(byClient).length} ¬∑ Total d√≠a: $${to2(totalDia)}`;
}
async function exportDiaCSV(){
  const f = diaFecha.value || todayISO();
  const { data: notas } = await supabase.from('notas_credito').select('id, folio, fecha, clientes(nombre)').eq('fecha', f);
  const ids=(notas||[]).map(n=>n.id);
  if(!ids.length) return alert('No hay notas ese d√≠a');
  const { data: det } = await supabase.from('notas_detalle').select('nota_id, producto, cantidad, precio, importe, created_at').in('nota_id', ids);

  const head=['Cliente','Folio','Fecha','Hora','Producto','Kg','Precio','Importe'];
  const rows=(det||[]).map(d=>{
    const n=(notas||[]).find(x=>x.id===d.nota_id) || {};
    return [(n.clientes?.nombre||''), n.folio, f, new Date(d.created_at).toLocaleTimeString(), d.producto, to2(d.cantidad), to2(d.precio), to2(d.importe)];
  });
  const csv=[head, ...rows].map(r=> r.map(csvEscape).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`reporte_${f}.csv`; a.click(); URL.revokeObjectURL(url);
}

/* ========================= CERRAR ========================= */
async function cerrarNota(){
  const n=activeNota(); if(!n) return alert('Sin nota');
  await supabase.from('notas_credito').update({estado:'cerrada'}).eq('id', n.id);
  await renderVista(); await loadBandeja();
  alert('‚úÖ Nota cerrada');
}
</script>
</body>
</html>
