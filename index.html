<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VDC360¬∞ ‚Äî Notas a Cr√©dito (LOCAL)</title>
  <style>
    :root{--ink:#111;--brand:#0a7a3b;--muted:#6b7280;--bg:#f6f7f8;--card:#fff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto}
    header{background:var(--brand);color:#fff;padding:14px 18px}
    header h1{margin:0;font-size:18px}
    main{max-width:1240px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:16px}
    h2{margin:0 0 10px 0;font-size:18px}
    label{display:block;margin-top:8px;font-size:14px;color:#111}
    input,select,button,textarea{width:100%;padding:10px;margin-top:6px;font-size:14px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #eef0f2;text-align:left;font-size:14px}
    th{background:#fafafa}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .grid-2{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .btn{cursor:pointer}
    .btn-primary{background:var(--brand);color:#fff;border:none}
    .btn-ghost{background:#fff;border:1px solid #e5e7eb;color:#111}
    .btn-muted{background:#111;color:#fff;border:none}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef7f0;color:#0a7a3b;font-size:12px}
    .muted{color:var(--muted);font-size:13px}
    .danger{color:#b91c1c}
    .slotbar{display:flex;gap:8px;align-items:center;margin-top:8px}
    .slotbtn{border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
    .slotbtn.active{background:#0a7a3b;color:#fff;border-color:#0a7a3b}
    .btn-sm{padding:4px 8px;font-size:12px}
    .cell-editing input{width:100%; padding:6px; font-size:14px}

    /* ====== IMPRESI√ìN GENERAL (nota individual / ticket80 usando ventana nueva) ====== */
    @media print{
      body *{visibility:hidden}
      #printArea, #printArea *{visibility:visible}
      #printArea{position:fixed; left:0; top:0}

      @page{
        size: A4 landscape;
        margin: 10mm;
      }

      #printArea:not(.ticket80){
        width:297mm;
        padding:8mm 10mm;
      }
      #printArea:not(.ticket80) h3{
        margin:0 0 4mm 0;
        font-size:14px;
      }
      #printArea:not(.ticket80) table{
        width:100%;
        border-collapse:collapse;
      }
      #printArea:not(.ticket80) th,
      #printArea:not(.ticket80) td{
        border:1px solid #aaa;
        padding:3px 4px;
        font-size:11px;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>VDC360¬∞ ¬∑ Notas a Cr√©dito (LOCAL ¬∑ sin Supabase)</h1>
</header>

<main>
  <!-- SLOTS A/B -->
  <section class="card">
    <h2>üß≠ Trabajo en paralelo (2 clientes)</h2>
    <div class="slotbar">
      <button class="slotbtn active" id="slotA">Slot A</button>
      <span class="pill" id="slotALabel">‚Äî</span>
      <button class="slotbtn" id="slotB">Slot B</button>
      <span class="pill" id="slotBLabel">‚Äî</span>

      <span class="right flex" style="gap:6px">
        <input type="checkbox" id="exitGuardToggle" />
        <label for="exitGuardToggle" class="muted">Confirmar al salir</label>
      </span>
    </div>
  </section>

  <!-- CONTROLES (slot activo) -->
  <section class="card">
    <h2>üßæ Nota (Slot activo)</h2>
    <div class="row">
      <div>
        <label>Cliente</label>
        <div class="flex" style="gap:6px; align-items:stretch">
          <select id="cliSelect"></select>
          <button class="btn btn-ghost" id="btnNuevoCliente" type="button">+ Cliente</button>
        </div>
      </div>
      <div>
        <label>Tel√©fono (WhatsApp)</label>
        <input id="cliTelefono" placeholder="10 d√≠gitos / +52..." />
      </div>
    </div>
    <div class="row-3">
      <div>
        <label>Folio</label>
        <input id="notaFolio" placeholder="Autogenerado" />
      </div>
      <div>
        <label>Fecha</label>
        <input id="notaFecha" type="date" />
      </div>
      <div>
        <label>D√≠as de cr√©dito</label>
        <select id="notaDias">
          <option value="7">7</option>
          <option value="15">15</option>
          <option value="30" selected>30</option>
          <option value="45">45</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Vence</label>
        <input id="notaVence" type="date" />
      </div>
      <div>
        <label>&nbsp;</label>
        <div class="flex">
          <button class="btn btn-primary" id="btnContinuar" type="button">Crear / Continuar Nota en Slot Activo</button>
          <span class="pill right" id="notaInfo">Sin nota en slot</span>
        </div>
      </div>
    </div>
  </section>

  <div class="grid-2">
    <!-- CAPTURA -->
    <section class="card">
      <h2>üß∫ Capturar partidas</h2>
      <div class="row-3">
        <div>
          <label>Producto</label>
          <input id="pProducto" list="catProductos" placeholder="Ej. Panza de Res" />
        </div>
        <div>
          <label>Kilos</label>
          <div class="flex" style="gap:6px; align-items:center">
            <input id="pKg" type="number" min="0" step="0.01" value="1" />
            <div class="flex">
              <button class="btn btn-ghost btnInc" data-d="0.1" type="button">+0.1</button>
              <button class="btn btn-ghost btnInc" data-d="0.5" type="button">+0.5</button>
              <button class="btn btn-ghost btnInc" data-d="1"   type="button">+1</button>
            </div>
          </div>
        </div>
        <div>
          <label>Piezas (opcional)</label>
          <input id="pPzas" type="number" min="0" step="1" />
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Precio/kg</label>
        <input id="pPrecio" type="number" min="0" step="0.01" value="0" />
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn btn-primary" id="btnAgregar" type="button">Agregar a nota (Enter)</button>
        <span class="pill right" id="subtotalBox">Subtotal: $0.00</span>
      </div>
      <label>Observaciones (auto por producto)</label>
      <textarea id="notaObs" rows="3" placeholder="Se autogenera con totales por producto"></textarea>
    </section>

    <!-- VISTA EN VIVO -->
    <section class="card">
      <h2>üë§ Vista del cliente (slot activo)</h2>
      <div class="flex" style="gap:6px;margin-bottom:6px">
        <div class="pill">Folio: <span id="vFolio">‚Äî</span></div>
        <div class="pill">Estado: <span id="vEstado">‚Äî</span></div>
        <div class="pill">Saldo: $<span id="vSaldo">0.00</span></div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th>Producto</th>
            <th>Kg</th>
            <th>Pzas</th>
            <th>P.Unit</th>
            <th>Importe</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="vistaBody"></tbody>
        <tfoot><tr><td colspan="6" style="text-align:right">Total</td><td id="vistaTotal">$0.00</td></tr></tfoot>
      </table>
    </section>
  </div>

  <!-- BANDEJA -->
  <section class="card">
    <h2>üì• Notas abiertas hoy (todas)</h2>
    <div class="row">
      <div>
        <label>Fecha</label>
        <input id="bandejaFecha" type="date" />
      </div>
      <div>
        <label>&nbsp;</label>
        <div class="flex">
          <button class="btn btn-ghost" id="btnBandeja" type="button">Actualizar</button>
          <span class="muted">Carga una nota al Slot A o B para alternar r√°pido.</span>
        </div>
      </div>
    </div>
    <table>
      <thead><tr><th>Folio</th><th>Cliente</th><th>Saldo</th><th>Estado</th><th>Acciones</th></tr></thead>
      <tbody id="bandejaBody"></tbody>
    </table>
  </section>

  <!-- REPORTE DIARIO GENERAL -->
  <section class="card">
    <h2>üìÑ Reporte diario GENERAL (todos los clientes)</h2>
    <div class="row">
      <div>
        <label>Fecha</label>
        <input id="diaFecha" type="date" />
      </div>
      <div>
        <label>&nbsp;</label>
        <div class="flex">
          <button class="btn btn-ghost" id="btnDiaA4" type="button">Imprimir A4 (todos)</button>
          <button class="btn btn-ghost" id="btnDiaCSV" type="button">CSV (todos)</button>
          <span class="pill right" id="diaResumen">‚Äî</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ACCIONES NOTA -->
  <section class="card">
    <div class="flex">
      <button class="btn btn-ghost" id="btnWA" type="button">WhatsApp Cuenta</button>
      <button class="btn btn-ghost" id="btnImprimir" type="button">Imprimir A4</button>
      <button class="btn btn-ghost" id="btnImprimir80" type="button">Imprimir 80mm</button>
      <button class="btn btn-ghost" id="btnCSV" type="button">Exportar CSV</button>
      <button class="btn btn-ghost danger right" id="btnCerrar" type="button">Cerrar Nota</button>
    </div>
    <div class="flex" style="margin-top:10px">
      <button class="btn btn-muted" id="btnExportDB" type="button">Respaldar (Exportar JSON)</button>
      <button class="btn btn-muted" id="btnImportDB" type="button">Restaurar (Importar JSON)</button>
      <button class="btn btn-ghost danger" id="btnResetDB" type="button">Borrar TODO (local)</button>
      <input type="file" id="importFile" accept="application/json" style="display:none" />
      <span class="muted">* Todo se guarda local en este navegador.</span>
    </div>
  </section>
</main>

<div id="printArea" style="display:none"></div>
<datalist id="catProductos"></datalist>

<script>
/* ========================= CONFIG ========================= */
const STORE_NAME = "Carnes y V√≠sceras del Centro";
const DBKEY = "VDC360_LOCAL_DB_v1";

/* ========================= UTILS ========================= */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const to2 = n=> Number(n||0).toFixed(2);
function todayISO(){ const d=new Date(); const z=d.getTimezoneOffset()*60000; return new Date(d-z).toISOString().slice(0,10); }
function addDays(dateISO, days){ const d=new Date(dateISO); d.setDate(d.getDate()+Number(days||0)); const z=d.getTimezoneOffset()*60000; return new Date(d - z).toISOString().slice(0,10); }
function genFolio(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return `CVC-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`; }
function csvEscape(s){ return '"'+String(s).replaceAll('"','""')+'"'; }
function uid(){ return (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())+"-"+Math.random().toString(16).slice(2)); }

/* === Observaciones autom√°ticas por producto === */
function buildAutoObsFromDetalle(det){
  if(!det || !det.length) return '';
  const grupos = {};
  det.forEach(d=>{
    const prod = d.producto || 'Sin producto';
    if(!grupos[prod]) grupos[prod] = { kg:0, pzas:0, tienePzas:false };
    grupos[prod].kg += Number(d.cantidad || 0);
    if(d.piezas != null){
      grupos[prod].pzas += Number(d.piezas || 0);
      grupos[prod].tienePzas = true;
    }
  });
  return Object.entries(grupos).map(([prod, g])=>{
    const kgTxt = to2(g.kg);
    const pzasTxt = g.tienePzas ? ` / ${g.pzas} pzas` : '';
    return `TOTAL ${prod} = ${kgTxt}${pzasTxt}`;
  }).join('\n');
}

/* ========================= DB LOCAL ========================= */
function defaultSeed(){
  // Productos (de tu lista)
  const productos = [
    "Caja Azul Xkg","Cabeza De Rastro","Tripa","Medula","Caja Excel Completa","Higado",
    "Caja Menudo Visceras Del Centro","Barra de Hielo","Tripa Gorda","Pata Morena",
    "Caja Azul Completa","Cabeza Sin Lengua","Pata Blanca","Lengua","PT","Cabeza Congelada",
    "Tripa de Rastro","Caja Menudo National","Menudo Canadian XKG","Corazon","Pellejo",
    "Caja Libro Visceras","Caja de Tripa Gorda","Caja Menudo Washington","Pata Sucia","Teleco",
    "Hueso","Menudo Sucio","Caja Excel XKg","Cabeza","Sebo","Caja Menudo Canadian","Bofe",
    "Cuajo","Bofe Completo","Creadillas","Libro","Panza de Res","Caja de Tripa Delgada"
  ].map(nombre=>({ id: uid(), nombre, precio_kg: 0, activo:true }));

  // Clientes (de tu lista, nombre + tel√©fono si existe)
  const clientes = [
    ["Jos√© Juan","+523313505078"],
    ["Alejandro Gonzales",null],
    ["Elias",null],
    ["Pepe Velazquez","+524623239323"],
    ["Marcelino","+524438572648"],
    ["Chato","+524623095231"],
    ["Nacho","+524621080101"],
    ["Ortega","+524561005706"],
    ["Josue","+524621076210"],
    ["Meche",null],
    ["Salvador Ayala","+524431392412"],
    ["Yerno Cuco","+524622692871"],
    ["Leandro Ayala","+524291224253"],
    ["Daniel",null],
    ["Javier Navarro","+524611556351"],
    ["Gabriel Arenas","+524771341678"],
    ["Chaparrita",null],
    ["Elias Vargas",null],
    ["Leonardo Borja",null],
    ["Penjamo",null],
    ["Neto",null],
    ["Paisaa","+5246221411029"],
    ["Ing Rayo",null],
    ["Mar√≠a Murillo","+524431861403"],
    ["Don Jauregui","+524438572648"],
    ["Manuel Acu√±a","+524623290813"],
    ["Tacos Gory",null],
    ["Alberto Ayala","+524431269273"],
    ["Pedro Valadez","+524525251539"],
    ["Carrillo","+524641599790"],
    ["Alejandro Perez","+524621555525"],
    ["Poncho Ayala","+524341045316"],
    ["Juan Pedro Velazquez","+524623239323"],
    ["Bel√©n",null],
    ["Rafa","+524622108109"],
    ["Clara","+524624840803"],
    ["Saul linares","+524291055228"],
    ["Pieles y Grasas","8112559296"],
    ["Sra. de Felipe",null],
    ["Nota Cr√©dito",null],
    ["Ojo Zarco",null],
    ["Adriana","+524622527782"],
    ["Villa Rosita","+524621570742"],
    ["Meche",null],
    ["Flama","+524621467611"],
    ["Paisa Chema","+524623067105"],
    ["Hermano  Rafa",null],
    ["Guadalupe Granados","+524622729790"],
    ["Linares",null],
    ["Le√≥n","+524621766388"],
    ["PRUEBA",null],
    ["Jes√∫s Z",null],
    ["Gustavo","+527861219393"],
    ["Cuco",null],
    ["El√≠seo Sanchez","+524691044508"],
    ["Jose Villegas","+523521390324"],
    ["Ruben","+524111063731"],
    ["Mario Lolis","+524621035675"],
    ["Alejandro Rivera","+524111615955"],
    ["Rastro",null],
    ["Roberto",null],
    ["Otomi","+524611691774"],
    ["Do√±a mari","+524621298807"],
    ["Antonio Sosa","+524438751185"],
    ["Rodolfo","+524621991103"],
    ["Mely","+524431724777"],
    ["Manuel Gasc√≥n","+524434108137"],
    ["Tacos los G√ºeros","+524625991914"],
    ["Trino","+524623098165"],
    ["Acuario","+524622136821"],
    ["Toro Real","+524361501083"],
    ["Carmen Garcia","+524622087228"],
    ["Jenny","+524777370596"],
    ["Juan Jos√© vazquez","+524622218466"],
    ["Miguel Velazquez","+524623239323"],
    ["Andres Silao","+524721799360"],
    ["Angelica Castro","+524623543989"],
    ["Valeria","+524433656176"],
    ["Vicenta","+524691551323"],
    ["David","+524626047420"],
    ["Monje","+524621490933"],
    ["Pecas",null],
    ["Do√±a Lorena",null],
    ["Arturo Rivera","+524111771904"],
    ["Alfredo Mora","+524381236201"],
    ["Carniceria","+524622201454"]
  ].map(([nombre, telefono])=>({ id: uid(), nombre, telefono: telefono||null, activo:true }));

  return {
    clientes,
    productos,
    notas_credito: [],    // {id, folio, fecha, vence, cliente_id, estado, total, saldo, observaciones, created_at}
    notas_detalle: [],    // {id, nota_id, producto, cantidad, piezas, precio, importe, created_at}
    _meta: { created_at: new Date().toISOString() }
  };
}
function loadDB(){
  const raw = localStorage.getItem(DBKEY);
  if(!raw){
    const seed = defaultSeed();
    localStorage.setItem(DBKEY, JSON.stringify(seed));
    return seed;
  }
  try{
    const db = JSON.parse(raw);
    if(!db || !db.clientes || !db.productos) throw new Error("bad db");
    return db;
  }catch{
    const seed = defaultSeed();
    localStorage.setItem(DBKEY, JSON.stringify(seed));
    return seed;
  }
}
function saveDB(db){ localStorage.setItem(DBKEY, JSON.stringify(db)); }
let DB = loadDB();

/* ========================= STATE ========================= */
let CLIENTES=[], PRODUCTOS=[], PRECIOS={};
let slotActive='A';
let notaA=null, notaB=null;
const slotState = { A:{cliente_id:null, telefono:null}, B:{cliente_id:null, telefono:null} };

/* ===== Protector de salida ===== */
let exitGuardEnabled = JSON.parse(localStorage.getItem('exitGuardEnabled') || 'true');
let isDirty = false;
function markDirty(){ if(exitGuardEnabled) isDirty = true; }
function clearDirty(){ isDirty = false; }

/* ========================= REFS ========================= */
const exitGuardToggle=$('#exitGuardToggle');
const slotABtn=$('#slotA'), slotBBtn=$('#slotB');
const slotALabel=$('#slotALabel'), slotBLabel=$('#slotBLabel');
const cliSelect=$('#cliSelect');
const cliTelefono=$('#cliTelefono');
const notaFolio=$('#notaFolio');
const notaFecha=$('#notaFecha');
const notaDias=$('#notaDias');
const notaVence=$('#notaVence');
const notaInfo=$('#notaInfo');
const pProducto=$('#pProducto');
const pKg=$('#pKg');
const pPzas=$('#pPzas');
const pPrecio=$('#pPrecio');
const subtotalBox=$('#subtotalBox');
const vFolio=$('#vFolio');
const vEstado=$('#vEstado');
const vSaldo=$('#vSaldo');
const vistaBody=$('#vistaBody');
const vistaTotal=$('#vistaTotal');
const bandejaFecha=$('#bandejaFecha');
const bandejaBody=$('#bandejaBody');
const diaFecha=$('#diaFecha');
const diaResumen=$('#diaResumen');
const notaObs=$('#notaObs');

/* ========================= INIT UI ========================= */
notaFecha.value=todayISO();
notaVence.value=addDays(notaFecha.value, notaDias.value);
bandejaFecha.value=todayISO();
diaFecha.value=todayISO();

exitGuardToggle.checked = exitGuardEnabled;
exitGuardToggle.addEventListener('change', ()=>{
  exitGuardEnabled = exitGuardToggle.checked;
  localStorage.setItem('exitGuardEnabled', JSON.stringify(exitGuardEnabled));
  if(!exitGuardEnabled) clearDirty();
});
window.addEventListener('beforeunload', (e)=>{
  if(exitGuardEnabled && isDirty){ e.preventDefault(); e.returnValue = ''; }
});

notaDias.addEventListener('change', ()=> { notaVence.value=addDays(notaFecha.value, notaDias.value); });
notaFecha.addEventListener('change', ()=> { notaVence.value=addDays(notaFecha.value, notaDias.value); });

['keyup','change'].forEach(ev=> pProducto.addEventListener(ev, ()=>{ prefPrecio(); markDirty(); }));
['keyup','change'].forEach(ev=> pKg.addEventListener(ev, markDirty));
['keyup','change'].forEach(ev=> pPzas.addEventListener(ev, markDirty));
['keyup','change'].forEach(ev=> pPrecio.addEventListener(ev, markDirty));

$$('.btnInc').forEach(b=> b.addEventListener('click', ()=>{
  pKg.value=(Number(pKg.value||0)+Number(b.dataset.d||0)).toFixed(2);
  markDirty();
}));

document.addEventListener('keydown', (e)=>{ 
  if(e.key==='Enter' && document.activeElement && ['pProducto','pKg','pPzas','pPrecio'].includes(document.activeElement.id)){ 
    e.preventDefault(); 
    addPartida(); 
  }
});

// Botones
$('#btnContinuar').addEventListener('click', continuarNota);
$('#btnAgregar').addEventListener('click', addPartida);
$('#btnWA').addEventListener('click', ()=> activeNota() && waNota(activeNota().id));
$('#btnImprimir').addEventListener('click', ()=> activeNota() && imprimirNotaA4(activeNota().id));
$('#btnImprimir80').addEventListener('click', ()=> activeNota() && imprimirNota80mm(activeNota().id));
$('#btnCSV').addEventListener('click', ()=> activeNota() && exportNotaCSV(activeNota().id));
$('#btnCerrar').addEventListener('click', cerrarNota);
$('#btnNuevoCliente').addEventListener('click', addCliente);
$('#btnBandeja').addEventListener('click', loadBandeja);
$('#btnDiaA4').addEventListener('click', imprimirDiaA4);
$('#btnDiaCSV').addEventListener('click', exportDiaCSV);

// Backups
$('#btnExportDB').addEventListener('click', exportDBJson);
$('#btnImportDB').addEventListener('click', ()=> $('#importFile').click());
$('#importFile').addEventListener('change', importDBJson);
$('#btnResetDB').addEventListener('click', resetDB);

// Cambios cliente/tel√©fono slot
cliSelect.addEventListener('change', ()=>{
  slotState[slotActive].cliente_id = cliSelect.value || null;
  const c = getClient(slotState[slotActive].cliente_id);
  cliTelefono.value = c ? (c.telefono || '') : '';
  slotState[slotActive].telefono = cliTelefono.value || null;
});
cliTelefono.addEventListener('blur', ()=>{ saveClientPhone(); });

slotABtn.onclick=()=> setActiveSlot('A');
slotBBtn.onclick=()=> setActiveSlot('B');

window.addEventListener('load', ()=>{
  loadCatalogosFromDB();
  notaFolio.value=genFolio();
  loadBandeja();
  if (CLIENTES[0]) {
    slotState.A.cliente_id = CLIENTES[0].id;
    slotState.A.telefono   = CLIENTES[0].telefono || null;
    applySlotUI('A');
  }
});

/* ========================= CAT√ÅLOGOS ========================= */
function loadCatalogosFromDB(){
  DB = loadDB();
  CLIENTES = (DB.clientes||[]).filter(c=>c.activo!==false).sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
  PRODUCTOS = (DB.productos||[]).filter(p=>p.activo!==false).sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
  PRECIOS = Object.fromEntries(PRODUCTOS.map(p=>[p.nombre, Number(p.precio_kg||0).toFixed(2)]));

  cliSelect.innerHTML = (CLIENTES||[]).map(c=>`<option value="${c.id}">${c.nombre}</option>`).join('');
  $('#catProductos').innerHTML = PRODUCTOS.map(p=>`<option value="${p.nombre}"></option>`).join('');
}
function prefPrecio(){ 
  const n=(pProducto.value||'').trim(); 
  if(PRECIOS[n] != null) pPrecio.value=PRECIOS[n]; 
}

/* ========================= HELPERS ========================= */
function getClient(id){ return (CLIENTES||[]).find(c=> String(c.id)===String(id)); }
function getClientName(id){ return getClient(id)?.nombre || ''; }
function activeNota(){ return slotActive==='A' ? notaA : notaB; }
function setActiveSlot(s){
  slotActive=s;
  slotABtn.classList.toggle('active', s==='A');
  slotBBtn.classList.toggle('active', s==='B');
  applySlotUI(s);
  renderVista();
  refreshNotaInfo();
}
function setSlotNota(s, nota){
  if(s==='A') notaA=nota; else notaB=nota;
  slotState[s].cliente_id = nota.cliente_id || slotState[s].cliente_id;
  const c = getClient(slotState[s].cliente_id);
  slotState[s].telefono = c ? (c.telefono || null) : slotState[s].telefono;
  if(slotActive===s){ applySlotUI(s); renderVista(); }
  refreshNotaInfo();
}
function refreshNotaInfo(){
  slotALabel.textContent = notaA ? `${notaA.folio}` : '‚Äî';
  slotBLabel.textContent = notaB ? `${notaB.folio}` : '‚Äî';
  const n = activeNota();
  notaInfo.textContent = n ? `Nota: ${n.folio}` : 'Sin nota en slot';
}
function applySlotUI(s){
  const n   = (s==='A') ? notaA : notaB;
  const cid = (n?.cliente_id) || slotState[s].cliente_id || (CLIENTES[0]?.id || '');
  cliSelect.value = cid;
  const c = getClient(cid);
  cliTelefono.value = (n && c) ? (c.telefono || '') : (slotState[s].telefono || c?.telefono || '');
}

/* ========================= GUARDAR TEL√âFONO ========================= */
function saveClientPhone(){
  const cid = slotState[slotActive].cliente_id || activeNota()?.cliente_id;
  if(!cid) return;
  const val = (cliTelefono.value||'').trim() || null;
  const idx = DB.clientes.findIndex(x=>String(x.id)===String(cid));
  if(idx>=0){
    DB.clientes[idx].telefono = val;
    saveDB(DB);
    loadCatalogosFromDB();
    const c = getClient(cid);
    slotState[slotActive].telefono = c ? (c.telefono||null) : val;
  }
}

/* ========================= CREAR/CONTINUAR NOTA ========================= */
function continuarNota(){
  const cliente_id = slotState[slotActive].cliente_id || cliSelect.value;
  if(!cliente_id) return alert('Selecciona cliente');
  const fecha = notaFecha.value || todayISO();

  // buscar nota abierta existente mismo cliente y fecha
  let nota = (DB.notas_credito||[])
    .filter(n=>n.estado==='abierta' && n.cliente_id===cliente_id && n.fecha===fecha)
    .sort((a,b)=> (b.created_at||'').localeCompare(a.created_at||''))[0] || null;

  if(!nota){
    const folio = genFolio();
    nota = { 
      id: uid(),
      folio,
      fecha,
      vence:(notaVence.value||addDays(fecha, notaDias.value)),
      cliente_id,
      estado:'abierta',
      total:0,
      saldo:0,
      observaciones: '',
      created_at: new Date().toISOString()
    };
    DB.notas_credito.push(nota);
    saveDB(DB);
  }

  setSlotNota(slotActive, nota);
  notaFolio.value = nota.folio;
  renderVista();
}

/* ========================= NUEVO CLIENTE ========================= */
function addCliente(){
  const nombre = prompt('Nombre del cliente:'); 
  if(!nombre || !nombre.trim()) return;
  const telefono = prompt('Tel√©fono (WhatsApp, opcional):') || null;
  const row = { id: uid(), nombre: nombre.trim(), telefono: telefono||null, activo:true, created_at: new Date().toISOString() };
  DB.clientes.push(row);
  saveDB(DB);
  loadCatalogosFromDB();
  slotState[slotActive].cliente_id = row.id;
  slotState[slotActive].telefono = row.telefono || null;
  applySlotUI(slotActive);
  alert('‚úÖ Cliente creado');
}

/* ========================= INSERTAR PARTIDA ========================= */
function addPartida(){
  const nota = activeNota(); 
  if(!nota) return alert('Primero crea/contin√∫a una nota en el slot activo');
  const prod=(pProducto.value||'').trim(), 
        cant=Number(pKg.value||0), 
        piezas = (pPzas.value !== '' && pPzas.value != null) ? Number(pPzas.value||0) : null,
        precio=Number(pPrecio.value||0);

  if(!prod || cant<=0) return alert('Producto y kilos son obligatorios');

  DB.notas_detalle.push({ 
    id: uid(), 
    nota_id: nota.id, 
    producto: prod, 
    cantidad: cant, 
    piezas: (piezas!=null && !isNaN(piezas) && piezas>0) ? Math.round(piezas) : null,
    precio, 
    importe: cant*precio,
    created_at: new Date().toISOString()
  });

  saveDB(DB);

  pProducto.value=''; 
  pKg.value='1'; 
  pPzas.value='';
  prefPrecio();
  clearDirty();
  recalcNota(nota.id);
  renderVista();
  loadBandeja();
}

function recalcNota(nota_id){
  const det = (DB.notas_detalle||[]).filter(d=>d.nota_id===nota_id);
  const total = det.reduce((a,b)=>a+Number(b.importe||0),0);
  const idx = DB.notas_credito.findIndex(n=>n.id===nota_id);
  if(idx>=0){
    DB.notas_credito[idx].total = total;
    DB.notas_credito[idx].saldo = total;
    DB.notas_credito[idx].observaciones = buildAutoObsFromDetalle(det);
    saveDB(DB);
  }
}

/* ========================= VISTA (SLOT ACTIVO) ========================= */
function renderVista(){
  const n = activeNota();
  if(!n){
    vFolio.textContent='‚Äî'; 
    vEstado.textContent='‚Äî'; 
    vSaldo.textContent='0.00';
    vistaBody.innerHTML=''; 
    vistaTotal.textContent='$0.00'; 
    subtotalBox.textContent='Subtotal: $0.00';
    notaObs.value='';
    refreshNotaInfo(); 
    return;
  }

  // refrescar nota desde DB (por si cambi√≥)
  const nota = DB.notas_credito.find(x=>x.id===n.id) || n;
  if(slotActive==='A') notaA=nota; else notaB=nota;

  const det = (DB.notas_detalle||[])
    .filter(d=>d.nota_id===nota.id)
    .sort((a,b)=> (a.created_at||'').localeCompare(b.created_at||''));

  // auto-obs
  notaObs.value = buildAutoObsFromDetalle(det);
  const idx = DB.notas_credito.findIndex(x=>x.id===nota.id);
  if(idx>=0){ DB.notas_credito[idx].observaciones = notaObs.value; saveDB(DB); }

  slotState[slotActive].cliente_id = nota.cliente_id;
  const c = getClient(nota.cliente_id);
  slotState[slotActive].telefono = c ? (c.telefono || null) : slotState[slotActive].telefono;

  applySlotUI(slotActive);
  vFolio.textContent = nota.folio; 
  vEstado.textContent = nota.estado||'abierta'; 
  vSaldo.textContent = to2(nota.saldo||0);

  vistaBody.innerHTML = det.map(d=>`
    <tr data-id="${d.id}">
      <td>${new Date(d.created_at).toLocaleString()}</td>
      <td>${d.producto}</td>
      <td class="editable" data-field="cantidad">${to2(d.cantidad)}</td>
      <td class="editable" data-field="piezas">${d.piezas != null ? d.piezas : ''}</td>
      <td class="editable" data-field="precio">$${to2(d.precio)}</td>
      <td>$${to2(d.importe)}</td>
      <td><button class="btn btn-ghost btn-sm" data-del="${d.id}" title="Borrar">üóëÔ∏è</button></td>
    </tr>
  `).join('');

  const tot = det.reduce((a,b)=>a+Number(b.importe||0),0);
  vistaTotal.textContent=`$${to2(tot)}`; 
  subtotalBox.textContent=`Subtotal: $${to2(tot)}`;

  vistaBody.querySelectorAll('[data-del]').forEach(b=>{ b.onclick = ()=> deleteDetalle(b.dataset.del); });
  vistaBody.querySelectorAll('.editable').forEach(td=>{ td.addEventListener('click', ()=> makeCellEditable(td, nota.id)); });

  refreshNotaInfo();
}

/* ===== Editar en l√≠nea ===== */
function makeCellEditable(td, nota_id){
  if(td.classList.contains('cell-editing')) return;
  const field = td.dataset.field;
  const row   = td.closest('tr');
  const detId = row.dataset.id;
  const raw   = td.textContent.replace('$','').trim();
  let oldV    = raw ? Number(raw.replace(',', '.')) : null;

  td.classList.add('cell-editing');
  const input = document.createElement('input');
  input.type = 'number'; 
  input.step = (field==='piezas') ? '1' : '0.01'; 
  input.min  = '0';
  input.value = (oldV != null ? oldV : 0);
  td.innerHTML = ''; 
  td.appendChild(input);
  input.focus(); 
  input.select();
  markDirty();

  const commit = (save)=>{
    const newV = Number(input.value||'');
    td.classList.remove('cell-editing');

    const detIdx = DB.notas_detalle.findIndex(x=>x.id===detId);
    if(detIdx<0){
      td.innerHTML = raw;
      clearDirty();
      return;
    }

    if(!save){
      td.innerHTML = raw;
      clearDirty();
      return;
    }

    if(field==='piezas'){
      const newVal = (isNaN(newV) || newV <= 0) ? null : Math.round(newV);
      DB.notas_detalle[detIdx].piezas = newVal;
      // importe no depende de piezas
    } else if(field==='cantidad'){
      DB.notas_detalle[detIdx].cantidad = Number(newV||0);
    } else if(field==='precio'){
      DB.notas_detalle[detIdx].precio = Number(newV||0);
    }

    // recalcular importe si cambi√≥ cantidad/precio
    const d = DB.notas_detalle[detIdx];
    d.importe = Number(d.cantidad||0) * Number(d.precio||0);

    saveDB(DB);
    clearDirty();
    recalcNota(nota_id);
    renderVista();
    loadBandeja();
  };

  input.addEventListener('keydown', e=>{ 
    if(e.key==='Enter') commit(true); 
    if(e.key==='Escape') commit(false); 
  });
  input.addEventListener('blur', ()=> commit(true));
}

/* ===== Borrar partida ===== */
function deleteDetalle(detId){
  if(!confirm('¬øBorrar esta partida?')) return;
  const n = activeNota(); 
  if(!n) return;
  DB.notas_detalle = (DB.notas_detalle||[]).filter(d=>d.id!==detId);
  saveDB(DB);
  recalcNota(n.id);
  renderVista();
  loadBandeja();
}

/* ========================= BANDEJA ========================= */
function loadBandeja(){
  const f = bandejaFecha.value || todayISO();
  const rows = (DB.notas_credito||[])
    .filter(n=>n.fecha===f && n.estado==='abierta')
    .sort((a,b)=> (a.created_at||'').localeCompare(b.created_at||''));

  bandejaBody.innerHTML = rows.map(r=>{
    const cliente = getClientName(r.cliente_id);
    return `
      <tr>
        <td>${r.folio}</td>
        <td>${cliente}</td>
        <td>$${to2(r.saldo||0)}</td>
        <td>${r.estado||'abierta'}</td>
        <td class="flex">
          <button class="btn btn-ghost" data-usea="${r.id}">Usar en A</button>
          <button class="btn btn-ghost" data-useb="${r.id}">Usar en B</button>
          <button class="btn btn-ghost" data-a4="${r.id}">A4</button>
          <button class="btn btn-ghost" data-id80="${r.id}">80mm</button>
          <button class="btn btn-ghost" data-wa="${r.id}">WA</button>
        </td>
      </tr>
    `;
  }).join('');

  bandejaBody.querySelectorAll('[data-usea]').forEach(b=> b.onclick = ()=> cargarEnSlot('A', b.dataset.usea));
  bandejaBody.querySelectorAll('[data-useb]').forEach(b=> b.onclick = ()=> cargarEnSlot('B', b.dataset.useb));
  bandejaBody.querySelectorAll('[data-a4]').forEach(b=> b.onclick = ()=> imprimirNotaA4(b.dataset.a4));
  bandejaBody.querySelectorAll('[data-id80]').forEach(b=> b.onclick = ()=> imprimirNota80mm(b.dataset.id80));
  bandejaBody.querySelectorAll('[data-wa]').forEach(b=> b.onclick = ()=> waNota(b.dataset.wa));
}

function cargarEnSlot(slot, nota_id){
  const nota = (DB.notas_credito||[]).find(n=>n.id===nota_id);
  if(!nota) return;
  setSlotNota(slot, nota);
  setActiveSlot(slot);
}

/* ========================= WHATSAPP / A4 / CSV / 80mm ========================= */
function plantillaWA(nota, det, clienteNombre){
  const items = (det||[]).map(d=>{
    const piezasTxt = d.piezas ? ` (${d.piezas} pzas)` : '';
    return `‚Ä¢ ${d.producto} ${to2(d.cantidad)}kg${piezasTxt}`;
  }).join('\n');
  return [
    `Hola *${clienteNombre}*,`,
    `te compartimos el detalle de tu cuenta del d√≠a:\n`,
    `*Folio:* ${nota.folio}`,
    `*Fecha:* ${nota.fecha}`,
    '',
    items,
    '',
    nota.observaciones ? `*Notas:* ${nota.observaciones}` : '',
    '',
    `¬°Gracias por tu preferencia! ‚Äî ${STORE_NAME}`
  ].filter(Boolean).join('\n');
}

function waNota(nota_id){
  const nota = (DB.notas_credito||[]).find(n=>n.id===nota_id);
  if(!nota) return;

  const det = (DB.notas_detalle||[]).filter(d=>d.nota_id===nota_id).sort((a,b)=> (a.created_at||'').localeCompare(b.created_at||''));
  const nombre = getClientName(nota.cliente_id);

  const c = getClient(nota.cliente_id);
  const phoneRaw = (c?.telefono || '').trim();
  if(!phoneRaw){
    alert('El cliente no tiene tel√©fono guardado. Captura el n√∫mero y vuelve a intentar.');
    return;
  }
  const digits = phoneRaw.replace(/[^\d]/g,'');
  if(!digits){
    alert('El tel√©fono del cliente no es v√°lido.');
    return;
  }

  const msg = plantillaWA(nota, det, nombre);
  const u=`https://wa.me/${digits}?text=${encodeURIComponent(msg)}`;
  const u2=`https://api.whatsapp.com/send?phone=${digits}&text=${encodeURIComponent(msg)}`;
  const w=window.open(u,"_blank"); 
  setTimeout(()=>{ if(!w||w.closed) window.open(u2,"_blank"); }, 600);
}

function imprimirNotaA4(nota_id){
  const nota = (DB.notas_credito||[]).find(n=>n.id===nota_id);
  if(!nota) return;

  const det = (DB.notas_detalle||[]).filter(d=>d.nota_id===nota_id).sort((a,b)=> (a.created_at||'').localeCompare(b.created_at||''));
  const cliente = getClientName(nota.cliente_id);

  const el = $('#printArea'); 
  el.style.display='block'; 
  el.classList.remove('ticket80');
  el.innerHTML = `
    <h3>Nota ‚Äî ${cliente}</h3>
    <div><b>Folio:</b> ${nota.folio} &nbsp; <b>Fecha:</b> ${nota.fecha} &nbsp; <b>Vence:</b> ${nota.vence||''}</div>
    <div><b>Total:</b> $${to2(nota.total)} &nbsp; <b>Saldo:</b> $${to2(nota.saldo)}</div>
    ${nota.observaciones ? `<div style="margin-top:6mm"><b>Notas:</b><br>${(nota.observaciones||'').replace(/\n/g,'<br>')}</div>` : ''}
    <br/>
    <table>
      <thead><tr><th>Fecha/Hora</th><th>Producto</th><th>Kg</th><th>Pzas</th><th>P.Unit</th><th>Importe</th></tr></thead>
      <tbody>${det.map(d=>`<tr>
        <td>${new Date(d.created_at).toLocaleString()}</td>
        <td>${d.producto}</td>
        <td>${to2(d.cantidad)}</td>
        <td>${d.piezas != null ? d.piezas : ''}</td>
        <td>$${to2(d.precio)}</td>
        <td>$${to2(d.importe)}</td>
      </tr>`).join('')}</tbody>
    </table>`;
  window.print(); 
  setTimeout(()=>{ el.style.display='none'; el.innerHTML=''; }, 500);
}

function imprimirNota80mm(nota_id){
  const nota = (DB.notas_credito||[]).find(n=>n.id===nota_id);
  if(!nota) return;

  const det = (DB.notas_detalle||[]).filter(d=>d.nota_id===nota_id).sort((a,b)=> (a.created_at||'').localeCompare(b.created_at||''));
  const cliente = getClientName(nota.cliente_id) || '(sin nombre)';
  const obs = nota.observaciones || '‚Äî';

  const filas = det.map(d=>{
    const cantidadTexto = d.piezas ? `${to2(d.cantidad)} (${d.piezas}pz)` : to2(d.cantidad);
    return `<tr><td>${d.producto}</td><td class="right">${cantidadTexto}</td></tr>`;
  }).join('');

  const html = `
  <!DOCTYPE html><html lang="es"><head><meta charset="utf-8" />
  <title>Ticket 80mm</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;background:#fff;color:#111;font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    #ticket{background:#fff;padding:6px;max-width:80mm;margin:0 auto;}
    h3{margin:0 0 4px;text-align:center;font-size:14px}
    .meta{font-size:11px;margin-bottom:4px}
    .obs-block{margin-top:2px;white-space:pre-wrap}
    table{width:100%;border-collapse:collapse;font-size:11px;table-layout:fixed}
    td,th{padding:2px 1px;border-bottom:1px dashed #ddd;word-wrap:break-word}
    .right{text-align:right}
    @media print{
      @page { size: 80mm auto; margin: 0mm; }
      #ticket{width:80mm;max-width:80mm;margin:0;padding:2mm;}
      tr, td, th, table { page-break-inside: avoid; break-inside: avoid; }
    }
  </style></head><body>
    <div id="ticket">
      <h3>${STORE_NAME}</h3>
      <div class="meta">
        Nota a cr√©dito<br/>
        Cliente: ${cliente}<br/>
        Folio: ${nota.folio}<br/>
        Fecha: ${nota.fecha}<br/>
        <div class="obs-block">Obs:
${obs}</div>
      </div>
      <table>
        <thead><tr><th>Prod</th><th class="right">Kg/Pzas</th></tr></thead>
        <tbody>${filas}</tbody>
      </table>
      <div style="margin-top:6px;text-align:center;font-size:11px">
        ¬°Gracias por su preferencia! ¬°Carnes y Visceras del Centro tu mejor aliado!
      </div>
    </div>
  </body></html>`;

  const win = window.open('', '_blank', 'width=400,height=600');
  win.document.open(); win.document.write(html); win.document.close();
  win.focus();
  setTimeout(()=> win.print(), 300);
}

function exportNotaCSV(nota_id){
  const nota = (DB.notas_credito||[]).find(n=>n.id===nota_id);
  if(!nota) return;
  const cliente = getClientName(nota.cliente_id);
  const det = (DB.notas_detalle||[]).filter(d=>d.nota_id===nota_id).sort((a,b)=> (a.created_at||'').localeCompare(b.created_at||''));

  const head=['Cliente','Folio','Fecha','Hora','Producto','Kg','Piezas','Precio','Importe'];
  const rows = det.map(d=>[
    cliente,
    nota.folio,
    nota.fecha,
    new Date(d.created_at).toLocaleTimeString(),
    d.producto,
    to2(d.cantidad),
    (d.piezas!=null ? d.piezas : ''),
    to2(d.precio),
    to2(d.importe)
  ]);

  const csv=[head, ...rows].map(r=> r.map(csvEscape).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); 
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); 
  a.href=url; 
  a.download=`nota_${nota.folio}.csv`; 
  a.click(); 
  URL.revokeObjectURL(url);
}

/* ========================= REPORTE DIARIO GENERAL ========================= */
function imprimirDiaA4(){
  const f = diaFecha.value || todayISO();
  const notas = (DB.notas_credito||[])
    .filter(n=>n.fecha===f)
    .sort((a,b)=> (getClientName(a.cliente_id)||'').localeCompare(getClientName(b.cliente_id)||'') || (a.created_at||'').localeCompare(b.created_at||''));

  const ids = notas.map(n=>n.id);
  if(!ids.length) return alert('No hay notas ese d√≠a');

  const det = (DB.notas_detalle||[]).filter(d=> ids.includes(d.nota_id))
    .sort((a,b)=> (a.created_at||'').localeCompare(b.created_at||''));

  const byClient = {};
  notas.forEach(n=>{
    const c = getClientName(n.cliente_id) || '‚Äî';
    if(!byClient[c]) byClient[c] = { items: [], totalImporte: 0 };
  });

  det.forEach(d=>{
    const nota = notas.find(x=>x.id===d.nota_id);
    const cliente = getClientName(nota?.cliente_id) || '‚Äî';
    if(!byClient[cliente]) byClient[cliente] = { items: [], totalImporte: 0 };
    byClient[cliente].items.push({
      folio: nota?.folio || '',
      created_at: d.created_at,
      producto: d.producto,
      cantidad: d.cantidad,
      piezas: d.piezas,
      importe: d.importe
    });
    byClient[cliente].totalImporte += Number(d.importe || 0);
  });

  const totalDia = det.reduce((a,b)=>a+Number(b.importe||0),0);
  diaResumen.textContent = `Clientes: ${Object.keys(byClient).length} ¬∑ Total d√≠a: $${to2(totalDia)}`;

  let html = `
  <!DOCTYPE html><html lang="es"><head><meta charset="utf-8" />
  <title>Reporte diario</title>
  <style>
    @page { size: letter landscape; margin: 8mm; }
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; font-size: 11px; margin: 0; }
    h3 { margin: 0 0 4mm 0; font-size: 14px; }
    h4 { margin: 2mm 0 1mm 0; font-size: 11px; }
    .subinfo { font-size: 10px; margin-bottom: 3mm; }
    #columns { column-count: 2; column-gap: 5mm; }
    .client-group { break-inside: avoid; page-break-inside: avoid; margin-bottom: 3mm; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 2px 3px; font-size: 9.5px; text-align: left; }
    th { background: #f3f3f3; }
  </style></head><body>
    <h3>Reporte diario ‚Äî ${f}</h3>
    <div class="subinfo">Clientes: ${Object.keys(byClient).length} ¬∑ Total d√≠a: $${to2(totalDia)}</div>
    <div id="columns">`;

  Object.entries(byClient).forEach(([cliente, pack])=>{
    html += `<div class="client-group">
      <h4>${cliente} ‚Äî Total: $${to2(pack.totalImporte)}</h4>
      <table><thead><tr><th>Folio</th><th>Hora</th><th>Producto</th><th>Kg</th><th>Pzas</th></tr></thead><tbody>`;
    html += (pack.items||[]).map(d=>`
      <tr>
        <td>${d.folio}</td>
        <td>${new Date(d.created_at).toLocaleTimeString()}</td>
        <td>${d.producto}</td>
        <td>${to2(d.cantidad)}</td>
        <td>${d.piezas!=null ? d.piezas : ''}</td>
      </tr>`).join('');
    html += `</tbody></table></div>`;
  });

  html += `</div></body></html>`;

  const win = window.open('', '_blank', 'width=1200,height=800');
  win.document.open(); win.document.write(html); win.document.close();
  win.focus();
  setTimeout(()=> win.print(), 400);
}

function exportDiaCSV(){
  const f = diaFecha.value || todayISO();
  const notas = (DB.notas_credito||[]).filter(n=>n.fecha===f);
  const ids = notas.map(n=>n.id);
  if(!ids.length) return alert('No hay notas ese d√≠a');

  const det = (DB.notas_detalle||[]).filter(d=> ids.includes(d.nota_id));

  const head=['Cliente','Folio','Fecha','Hora','Producto','Kg','Piezas','Precio','Importe'];
  const rows = det.map(d=>{
    const n = notas.find(x=>x.id===d.nota_id);
    const cliente = getClientName(n?.cliente_id) || '';
    return [
      cliente,
      n?.folio || '',
      f,
      new Date(d.created_at).toLocaleTimeString(),
      d.producto,
      to2(d.cantidad),
      (d.piezas!=null ? d.piezas : ''),
      to2(d.precio),
      to2(d.importe)
    ];
  });

  const csv=[head, ...rows].map(r=> r.map(csvEscape).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); 
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); 
  a.href=url; 
  a.download=`reporte_${f}.csv`; 
  a.click(); 
  URL.revokeObjectURL(url);
}

/* ========================= CERRAR ========================= */
function cerrarNota(){
  const n = activeNota();
  if(!n) return alert('Sin nota');
  const idx = DB.notas_credito.findIndex(x=>x.id===n.id);
  if(idx>=0){
    DB.notas_credito[idx].estado='cerrada';
    saveDB(DB);
  }
  // limpiar slot activo
  if(slotActive==='A') notaA=null; else notaB=null;
  renderVista();
  loadBandeja();
  alert('‚úÖ Nota cerrada');
}

/* ========================= BACKUP / RESTORE ========================= */
function exportDBJson(){
  const blob = new Blob([JSON.stringify(DB,null,2)], {type:'application/json;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url;
  a.download=`VDC360_backup_${todayISO()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}
function importDBJson(e){
  const file = e.target.files?.[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const obj = JSON.parse(String(r.result||'{}'));
      if(!obj || !obj.clientes || !obj.productos) throw new Error("json inv√°lido");
      DB = obj;
      saveDB(DB);
      loadCatalogosFromDB();
      notaA=null; notaB=null;
      renderVista();
      loadBandeja();
      alert('‚úÖ Restaurado correctamente');
    }catch(err){
      alert('‚ùå No se pudo restaurar: JSON inv√°lido');
      console.error(err);
    }finally{
      $('#importFile').value='';
    }
  };
  r.readAsText(file);
}
function resetDB(){
  if(!confirm('¬øSeguro que quieres BORRAR TODO lo local?')) return;
  localStorage.removeItem(DBKEY);
  DB = loadDB();
  loadCatalogosFromDB();
  notaA=null; notaB=null;
  renderVista();
  loadBandeja();
  alert('‚úÖ Listo. Base local reiniciada.');
}

/* ========================= START ========================= */
function boot(){
  loadCatalogosFromDB();
  notaFolio.value=genFolio();
  renderVista();
  loadBandeja();
  refreshNotaInfo();
}
boot();
</script>
</body>
</html>




